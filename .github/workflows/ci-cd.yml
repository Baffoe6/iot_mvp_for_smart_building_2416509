name: CI/CD Pipeline - IoT MVP

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: eu-west-1
  TERRAFORM_VERSION: 1.6.0

jobs:
  lint-and-test-gateway:
    name: Lint and Test Gateway
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        working-directory: ./gateway
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pylint black
      
      - name: Lint with pylint
        working-directory: ./gateway
        run: pylint gateway.py
      
      - name: Check formatting with black
        working-directory: ./gateway
        run: black --check gateway.py
      
      - name: Run tests
        working-directory: ./gateway
        run: pytest --cov=. --cov-report=xml
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./gateway/coverage.xml
          flags: gateway

  validate-terraform:
    name: Validate Terraform
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Format Check
        working-directory: ./cloud/terraform
        run: terraform fmt -check -recursive
      
      - name: Terraform Init
        working-directory: ./cloud/terraform
        run: terraform init -backend=false
      
      - name: Terraform Validate
        working-directory: ./cloud/terraform
        run: terraform validate

  test-lambda-functions:
    name: Test Lambda Functions
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        working-directory: ./cloud/lambda
        run: |
          python -m pip install --upgrade pip
          pip install boto3 pytest moto
      
      - name: Run Lambda tests
        working-directory: ./cloud/lambda
        run: pytest

  build-web-dashboard:
    name: Build Web Dashboard
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ./web-dashboard/package-lock.json
      
      - name: Install dependencies
        working-directory: ./web-dashboard
        run: npm ci
      
      - name: Lint
        working-directory: ./web-dashboard
        run: npm run lint
      
      - name: Type check
        working-directory: ./web-dashboard
        run: npx tsc --noEmit
      
      - name: Run tests
        working-directory: ./web-dashboard
        run: npm test -- --run
      
      - name: Build
        working-directory: ./web-dashboard
        run: npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-dashboard-build
          path: web-dashboard/dist

  deploy-to-staging:
    name: Deploy to Staging
    needs: [lint-and-test-gateway, validate-terraform, test-lambda-functions, build-web-dashboard]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Init
        working-directory: ./cloud/terraform
        run: terraform init
      
      - name: Terraform Plan
        working-directory: ./cloud/terraform
        run: terraform plan -var="environment=staging" -out=tfplan
      
      - name: Terraform Apply
        working-directory: ./cloud/terraform
        if: github.event_name == 'push'
        run: terraform apply -auto-approve tfplan
      
      - name: Download dashboard build
        uses: actions/download-artifact@v4
        with:
          name: web-dashboard-build
          path: dist
      
      - name: Deploy dashboard to S3
        run: |
          aws s3 sync dist/ s3://iot-mvp-dashboard-staging --delete

  deploy-to-production:
    name: Deploy to Production
    needs: [lint-and-test-gateway, validate-terraform, test-lambda-functions, build-web-dashboard]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Init
        working-directory: ./cloud/terraform
        run: terraform init
      
      - name: Terraform Plan
        working-directory: ./cloud/terraform
        run: terraform plan -var="environment=prod" -out=tfplan
      
      - name: Terraform Apply
        working-directory: ./cloud/terraform
        run: terraform apply -auto-approve tfplan
      
      - name: Download dashboard build
        uses: actions/download-artifact@v4
        with:
          name: web-dashboard-build
          path: dist
      
      - name: Deploy dashboard to S3
        run: |
          aws s3 sync dist/ s3://iot-mvp-dashboard-prod --delete
          aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false
